#include "board.h"
#include "debug.h"
#include "modSysClock.h"


#define GPIO_AVR_RESET        GPIOC
#define GPIO_Pin_AVR_RESET    GPIO_Pin_10
#define GPIO_AVR_CLK          GPIOC
#define GPIO_Pin_AVR_CLK      GPIO_Pin_12
#define GPIO_AVR_MOSI         GPIOD
#define GPIO_Pin_AVR_MOSI     GPIO_Pin_0
#define GPIO_AVR_MISO         GPIOC
#define GPIO_Pin_AVR_MISO     GPIO_Pin_11
//#define GPIO_AVR_CLOCK         GPIOB
//#define GPIO_Pin_AVR_CLOCK     GPIO_Pin_11

#define AVR_RESET_L           (GPIO_AVR_RESET->BSRRH = GPIO_Pin_AVR_RESET)
#define AVR_RESET_H           (GPIO_AVR_RESET->BSRRL = GPIO_Pin_AVR_RESET)
#define AVR_CLK_L             (GPIO_AVR_CLK->BSRRH = GPIO_Pin_AVR_CLK)
#define AVR_CLK_H             (GPIO_AVR_CLK->BSRRL = GPIO_Pin_AVR_CLK)
#define AVR_MOSI_L            (GPIO_AVR_MOSI->BSRRH = GPIO_Pin_AVR_MOSI)
#define AVR_MOSI_H            (GPIO_AVR_MOSI->BSRRL = GPIO_Pin_AVR_MOSI)
//#define AVR_DAT_L             GPIO_ResetBits(GPIO_AVR_DAT, GPIO_Pin_AVR_MISO) 
//#define AVR_DAT_H             GPIO_SetBits(GPIO_AVR_DAT, GPIO_Pin_AVR_MISO)
#define AVR_MISO_IN           (GPIO_AVR_MISO->IDR & GPIO_Pin_AVR_MISO)
// #define AVR_CLOCK_INV      



#define PROG_AVR_DELAY_SPI    _delay_us(5)
//#define PROG_AVR_DELAY_WRITE  _delay_ms(10)
#define PROG_AVR_DELAY_MS(a)  _delay_ms(a)


uint8_t  progAVR_ID[3]; // Байты сигнатуры
uint8_t  progAVR_calibByte[4]; // Байты 

typedef enum {
    ATMEGA16A = 0,
    ATMEGA8A,
    ATMEGA8515,
    ATTINY2313,
    ATTINY13, //! - допроверить
    AT90S2313, //!
    
    AVR_PROG_CHIP_NUM
} PROG_AVR_FUSES;

static const uint8_t progAVR_constID[][3] = {
    {0x1E, 0x94, 0x03}, // ATMEGA16A
    {0x1E, 0x93, 0x07}, // ATMEGA8A
    {0x1E, 0x93, 0x06}, // ATMEGA8515
    {0x1E, 0x91, 0x0A}, // ATTINY2313
    {0x1E, 0x90, 0x07}, // ATTINY13
    {0x1E, 0x91, 0x0A}, // AT90S2313
};
uint16_t progAVR_mcu = 0; // num controller

static const uint8_t progAVR_constFusesDefault[][4] = {
    //fL    fH    LB    ex
    {0xE1, 0x99, 0xFF, 0xFF}, // ATMEGA16A
    {0xE1, 0xD9, 0xFF, 0xFF}, // ATMEGA8A
    {0xE1, 0xD9, 0xFF, 0xFF}, // ATMEGA8515
    {0x64, 0xDF, 0xFF, 0xFF}, // ATTINY2313
    {0x6A, 0xFF, 0xFF, 0xFF}, // ATTINY13 не точно
    {0x64, 0xDF, 0xFF, 0xFF}, // AT90S2313 не точно
};

static const uint16_t progAVR_constFLASHpageSize[] = {
    // Fsize
    64, // ATMEGA16A
    32, // ATMEGA8A
    32, // ATMEGA8515
    16, // ATTINY2313
    16, // ATTINY13!
    16, // AT90S2313!
};

#define PROG_AVR_FLASH_PAGE_MAX_SIZE    64 //256
uint16_t progAVR_FLASH_buf [PROG_AVR_FLASH_PAGE_MAX_SIZE - 0];
uint16_t progAVR_flasgSize = 0;
// fuzes
uint8_t  progAVR_fuzeL;
uint8_t  progAVR_fuzeH;
uint8_t  progAVR_lock;
uint8_t  progAVR_exten;
uint16_t progAVR_calibB;


// Программный спи 
uint8_t progAVR_xspi(uint8_t data) 
{ 
    uint8_t i;

    for (i = 0; i < 8; i++)
    {
        if (data & 0x80)//Выставить бит данных
        {
            AVR_MOSI_H;
        } else {
            AVR_MOSI_L;
        }
        data = data << 1;
        PROG_AVR_DELAY_SPI;
        AVR_CLK_H;
        PROG_AVR_DELAY_SPI;
	    if (AVR_MISO_IN)
        {
            data = data | 0x01;
        }
        AVR_CLK_L;
	    PROG_AVR_DELAY_SPI;
    }
	return data;
}


void progAVR_on_lines(void)
{
    GPIO_InitTypeDef GPIO_InitStructure;
    
    /* Enable Reset GPIO Clock */
    RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOC, ENABLE);
    RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOD, ENABLE);
    
    GPIO_StructInit (&GPIO_InitStructure);
    /* LEDs pin configuration -------------------------------------------------*/
    GPIO_InitStructure.GPIO_Pin =  (GPIO_Pin_AVR_CLK | GPIO_Pin_AVR_RESET);
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    GPIO_InitStructure.GPIO_PuPd  = GPIO_PuPd_NOPULL;
    GPIO_Init (GPIOC, &GPIO_InitStructure);
    
    GPIO_StructInit (&GPIO_InitStructure);
    /* LEDs pin configuration -------------------------------------------------*/
    GPIO_InitStructure.GPIO_Pin =  (GPIO_Pin_AVR_MOSI);
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    GPIO_InitStructure.GPIO_PuPd  = GPIO_PuPd_NOPULL;
    GPIO_Init (GPIOD, &GPIO_InitStructure);
    //#todo init MISO
    
    /*
    GPIO_InitTypeDef GPIO_InitStructure;
    
    GPIO_StructInit(&GPIO_InitStructure);
    GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_AVR_RESET |
                                    GPIO_Pin_AVR_CLK   |
                                    GPIO_Pin_AVR_MOSI;
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_10MHz;
	GPIO_Init(GPIOA, &GPIO_InitStructure);
    
    GPIO_StructInit(&GPIO_InitStructure);
    GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_AVR_MISO;
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_IPU;//GPIO_Mode_IN_FLOATING;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_10MHz;
	GPIO_Init(GPIOA, &GPIO_InitStructure);
    */
}


void progAVR_off_lines (void)
{
    GPIO_InitTypeDef GPIO_InitStructure;
    
    GPIO_StructInit (&GPIO_InitStructure);
    /* LEDs pin configuration -------------------------------------------------*/
    GPIO_InitStructure.GPIO_Pin =  (GPIO_Pin_AVR_CLK | GPIO_Pin_AVR_RESET);
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN;
    GPIO_InitStructure.GPIO_PuPd  = GPIO_PuPd_NOPULL;
    GPIO_Init (GPIOC, &GPIO_InitStructure);
    
    GPIO_StructInit (&GPIO_InitStructure);
    /* LEDs pin configuration -------------------------------------------------*/
    GPIO_InitStructure.GPIO_Pin =  (GPIO_Pin_AVR_MOSI);
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN;
    GPIO_InitStructure.GPIO_PuPd  = GPIO_PuPd_NOPULL;
    GPIO_Init (GPIOD, &GPIO_InitStructure);
    
    /*
    GPIO_InitTypeDef GPIO_InitStructure;
    
    GPIO_StructInit( &GPIO_InitStructure);
    GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_AVR_RESET |
                                    GPIO_Pin_AVR_CLK   |
                                    GPIO_Pin_AVR_MISO  |
                                    GPIO_Pin_AVR_MOSI;
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_IN_FLOATING;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOA, &GPIO_InitStructure);
    */
}


msg_t progAVR_progammingEnable(void)
{
    msg_t respond = FUNCTION_RETURN_ERROR;
    uint8_t t8;
                
    AVR_RESET_H;
    PROG_AVR_DELAY_MS(10);
    AVR_RESET_L;
    PROG_AVR_DELAY_MS(10);
    
    progAVR_xspi(0xAC);
    progAVR_xspi(0x53);
    t8 = progAVR_xspi(0xFF);
    if (t8 == 0x53)
        respond = FUNCTION_RETURN_OK;
    t8 = progAVR_xspi(0xFF);
    
    return respond;
}


msg_t progAVR_readID(void)
{
    msg_t respond = FUNCTION_RETURN_ERROR;
    uint16_t i;
    
    for (i = 0; i < 3; i++)
    {
        progAVR_xspi(0x30);
        progAVR_xspi(0x00);
        progAVR_xspi((uint8_t)i & 0x03);
        progAVR_ID[i] = progAVR_xspi(0xFF);
    }
    // Searching...
    for (i = 0; i < AVR_PROG_CHIP_NUM; i++) // @todo 3
    {
        if ((progAVR_ID[0] == progAVR_constID[i][0]) && \
            (progAVR_ID[1] == progAVR_constID[i][1]) && \
            (progAVR_ID[2] == progAVR_constID[i][2]))
        {
            progAVR_flasgSize = progAVR_constFLASHpageSize[i];
            progAVR_mcu = i;
            respond = FUNCTION_RETURN_OK;
        }
    }
    
    return respond;
}


void progAVR_erase_all (void) // FLASH+EEPROM
{
    progAVR_xspi(0xAC);
    progAVR_xspi(0x80);
    progAVR_xspi(0x00);
    progAVR_xspi(0x00);
    PROG_AVR_DELAY_MS(20);
}



void progAVR_FUSE_read (void)
{
    progAVR_xspi(0x50);
    progAVR_xspi(0x00);
    progAVR_xspi(0x00);
    progAVR_fuzeL = progAVR_xspi(0xFF);

    progAVR_xspi(0x58);
    progAVR_xspi(0x08);
    progAVR_xspi(0x00);
    progAVR_fuzeH = progAVR_xspi(0xFF);
    
    progAVR_xspi(0x58);
    progAVR_xspi(0x00);
    progAVR_xspi(0x00);
    progAVR_lock = progAVR_xspi(0xFF);
    
    progAVR_xspi(0x50);
    progAVR_xspi(0x08);
    progAVR_xspi(0x00);
    progAVR_exten = progAVR_xspi(0xFF);
    
//     // calib
//     progAVR_xspi(0x38);
//     progAVR_xspi(0x00);
//     progAVR_xspi(0x01);
//     progAVR_calibB = progAVR_xspi(0xFF);
//     progAVR_calibB =  progAVR_calibB << 8;
//             
//     progAVR_xspi(0x38);
//     progAVR_xspi(0x00);
//     progAVR_xspi(0x00);
//     progAVR_calibB |= progAVR_xspi(0xFF);
}


msg_t progAVR_FUSE_restore (void)
{
    msg_t respond = FUNCTION_RETURN_ERROR;
    uint8_t i;

    progAVR_erase_all();
    PROG_AVR_DELAY_MS(10); // x10
    
    progAVR_xspi(0xAC);
    progAVR_xspi(0xA0);
    progAVR_xspi(0x00); // //progAVR_fuzeL
    progAVR_xspi(progAVR_constFusesDefault[progAVR_mcu][0]);
    PROG_AVR_DELAY_MS(10);
    
//     progAVR_xspi(0xAC);
//     progAVR_xspi(0xA8);
//     progAVR_xspi(0x00); //progAVR_fuzeH
//     progAVR_xspi(progAVR_constFusesDefault[progAVR_mcu][1]);
//     PROG_AVR_DELAY_WRITE;

//     progAVR_xspi(0xAC);
//     progAVR_xspi(0xFF);
//     progAVR_xspi(0x00); // progAVR_lock
//     progAVR_xspi(progAVR_constFusesDefault[progAVR_mcu][2]);
//     PROG_AVR_DELAY_WRITE;

//     progAVR_xspi(0xAC);
//     progAVR_xspi(0xA4);
//     progAVR_xspi(0x00); // progAVR_exten 
//     progAVR_xspi(progAVR_constFusesDefault[progAVR_mcu][3]);
//     PROG_AVR_DELAY_WRITE;

    return respond;
}


msg_t progAVR_FUSE_write (void)
{
    msg_t respond = FUNCTION_RETURN_ERROR;
    uint8_t i;

    //progAVR_eraseAll();
    //PROG_AVR_DELAY_MS(10);; // x10
    
    progAVR_xspi(0xAC);
    progAVR_xspi(0xA0);
    progAVR_xspi(0x00); // //
    progAVR_xspi(progAVR_fuzeL);
    PROG_AVR_DELAY_MS(10);
    
    progAVR_xspi(0xAC);
    progAVR_xspi(0xA8);
    progAVR_xspi(0x00); //
    progAVR_xspi(progAVR_fuzeH);
    PROG_AVR_DELAY_MS(10);

    progAVR_xspi(0xAC);
    progAVR_xspi(0xFF);
    progAVR_xspi(0x00); // progAVR_lock
    progAVR_xspi(progAVR_lock);
    PROG_AVR_DELAY_MS(10);

//     progAVR_xspi(0xAC);
//     progAVR_xspi(0xA4);
//     progAVR_xspi(0x00); // progAVR_exten 
//     progAVR_xspi(progAVR_constFusesDefault[progAVR_mkType][3]);
//     PROG_AVR_DELAY_MS(10);

    return respond;
}


//uint8_t progAVR_dataEEPROM;
void  progAVR_readEEPROM (uint16_t adress, uint8_t *buf)
{
    progAVR_xspi(0xA0);
    progAVR_xspi(adress >> 8);
    progAVR_xspi(adress & 0xFF);
    *buf = progAVR_xspi(0xFF);
}


msg_t progAVR_writeEEPROM (uint16_t adress, uint8_t buf)
{
    msg_t respond = FUNCTION_RETURN_ERROR;
    uint8_t tmp8 = 0;
    
    progAVR_xspi(0xC0);
    progAVR_xspi(adress >> 8);
    progAVR_xspi(adress & 0xFF);
    progAVR_xspi(buf);
    PROG_AVR_DELAY_MS(10);
    progAVR_readEEPROM(adress, &tmp8);
    if (buf == tmp8)
        return FUNCTION_RETURN_OK;
    return respond;
}


msg_t progAVR_FLASH_byte_read (uint16_t adress, uint16_t *buf)
{
    msg_t respond = FUNCTION_RETURN_ERROR;
    uint16_t i;
    
    for (i = 0; i < progAVR_constFLASHpageSize[progAVR_mcu]; i++)
    {
        progAVR_xspi(0x28);
        progAVR_xspi((adress + i) >> 8);
        progAVR_xspi((adress + i) & 0xFF);
        buf[i] = progAVR_xspi(0xFF);
        
        buf[i] =  buf[i] << 8;
        
        progAVR_xspi(0x20);
        progAVR_xspi((adress + i) >> 8);
        progAVR_xspi((adress + i) & 0xFF);
        buf[i] |= progAVR_xspi(0xFF);
    }

    return respond;
}


msg_t progAVR_FLASH_page_write (uint16_t adress, uint16_t *buf)
{
    msg_t respond = FUNCTION_RETURN_ERROR;
    uint8_t i; //@todo 16bit?

    for (i = 0; i < progAVR_constFLASHpageSize[progAVR_mcu]; i++)
    {
        progAVR_xspi(0x40);
        progAVR_xspi(0x00);
        progAVR_xspi(i & 0xFF);
        progAVR_xspi(buf[i] & 0xFF);
        
        progAVR_xspi(0x48);
        progAVR_xspi(0x00);
        progAVR_xspi(i & 0xFF);
        progAVR_xspi(buf[i] >> 8);
    }
    adress = adress * progAVR_constFLASHpageSize[progAVR_mcu];
    progAVR_xspi(0x4C);
    progAVR_xspi(adress >> 8);
    progAVR_xspi(adress & 0xFF);
    progAVR_xspi(0x00); // 0xFF???
    
    PROG_AVR_DELAY_MS(20);

    return respond;
}


#include "modPaint.h"
#include "xprintf.h"
extern char _str [256]; // буфер строки на вывод


msg_t progAVR_init (void)
{
    msg_t respond = FUNCTION_RETURN_ERROR;
    
    AVR_RESET_H;
    AVR_CLK_L;
    AVR_MOSI_L;
    _delay_ms(2);
    AVR_RESET_L;
    progAVR_on_lines();
    _delay_ms(2);
    if (FUNCTION_RETURN_OK == progAVR_progammingEnable())
    {
        paint_putStrColRow (0, 5, (char *)"AVR CONNECT");
        if (FUNCTION_RETURN_OK == progAVR_readID())
        {
            xsprintf(_str, "ID:%02X:%02X:%02X", progAVR_ID[0], progAVR_ID[1], progAVR_ID[2]);
            paint_putStrColRow (0, 6, _str);
            respond = FUNCTION_RETURN_OK;
        }
    }
    else
    {
        paint_putStrColRow (0, 5, (char *)"AVR NOT CONNECT");
    }
    
    return respond;
}


#include "conv.h"

#define BOOT_ATMEGA16A 0
#define BOOT_ATMEGA8A 0
#define BOOT_ATMEGA8515 1

static const uint8_t pHEX[] = {
#if BOOT_ATMEGA8515
"\
:1000000039C01DC752C051C050C04FC04EC04DC0B6\
:100010004CC04BC04AC049C048C047C046C045C09C\
:1000200044C0040309041C037700770077002E0006\
:10003000660069007300630068006C002E006400B5\
:1000400065000E035500530042006100730070000C\
:1000500012011001FF000008C016DC0504010102B6\
:1000600000010902120001010080190904000000CA\
:100070000000000011241FBECFE5D2E0DEBFCDBFDF\
:1000800010E0A0E6B0E0ECE9F0E102C005900D92CE\
:10009000A236B107D9F710E0A2E6B0E001C01D9288\
:1000A000AA3AB107E1F74ED2F7C7AACF382F90E0AE\
:1000B00006C022B782B7821B8C33E0F39F5F931791\
:1000C000C0F3089580917B008DB9809178008EB93E\
:1000D0000895282F882311F42AE002C0883038F1CF\
:1000E00084E191E090937A008093790010927800F7\
:1000F00081E080937D002930A1F02A3018F4283067\
:1001000049F411C02B3021F02C3021F48093780079\
:1001100081E50AC082E580937B0081E080937800CE\
:10012000089582E501C083E580937B00089584EF04\
:1001300090E090937A00809379002430B1F02530DC\
:1001400038F42230B1F0233090F42130C9F415C0D6\
:10015000263031F0263038F0273091F483E00AC0A1\
:1001600020937D0008958CE005C088E103C080E302\
:1001700001C080E680937D00089580EC80937D002F\
:10018000089522B790917D0082B7821B8917E0F312\
:10019000089587B3806B87BBC498C79892B72091A6\
:1001A0007D0082B7891B8217E0F3C49A92B782B7A9\
:1001B000891B8217E0F3C4988091790090917A00AE\
:1001C0008451914031F480917B008DB98091780009\
:1001D0008EB910927C00089587B38F7487BB88B363\
:1001E0008F7488BB1DB80895482F50917D0020E082\
:1001F00030E047FF02C0C59A01C0C598220FB699EA\
:100200002F5FC79A92B782B7891B8517E0F3C7980B\
:1002100092B782B7891B8517E0F33F5F383011F042\
:10022000440FE7CF822F08958FB9779BFECF8FB110\
:1002300008950F931F9300E23EC0E0917900F09182\
:100240007A008CEA0995E0917900F0917A0083E5D3\
:100250000995E0917900F0917A0080E00995182FD6\
:10026000E0917900F0917A0080E00995133511F45E\
:1002700080E025C01DB822B790917D0082B7821B17\
:100280008917E0F3C49A22B782B7821B8917E0F37B\
:10029000C49822B782B7821B8917E0F38091790056\
:1002A00090917A008451914031F480917B008DB916\
:1002B000809178008EB9015008F0BFCF81E01F9186\
:1002C0000F9108959B01AC0181E1569547953795B3\
:1002D00027958A95D1F780917C008217D9F02093D9\
:1002E0007C00E0917900F0917A008DE40995E0912D\
:1002F0007900F0917A0080E00995E0917900F09121\
:100300007A0080917C000995E0917900F0917A0063\
:1003100080E009950895EF92FF920F931F937B0160\
:100320008C01D0DF8E2D8170880F880F880FE091AF\
:100330007900F0917A0080620995D801C70129E01F\
:10034000B695A795979587952A95D1F7E09179006D\
:10035000F0917A00099516950795F794E794E09146\
:100360007900F0917A008E2D0995E0917900F09155\
:100370007A0080E009951F910F91FF90EF9008950A\
:100380000F931F938C01E0917900F0917A0080EA3D\
:100390000995E0917900F0917A00812F0995E0911B\
:1003A0007900F0917A00802F0995E0917900F09121\
:1003B0007A0080E009951F910F910895FF920F93A5\
:1003C0001F938C01F62EE0917900F0917A0080EC79\
:1003D0000995E0917900F0917A00812F0995E091DB\
:1003E0007900F0917A00802F0995E0917900F091E1\
:1003F0007A008F2D09958EE159DE80E01F910F91D3\
:10040000FF900895CF92DF92EF92FF920F931F9388\
:100410006B017C01142F56DFE0917900F0917A0096\
:100420008CE40995D701C60149E0B695A795979543\
:1004300087954A95D1F7E0917900F0917A00099576\
:10044000D701C601B695A79597958795E091790054\
:10045000F0917A000995E0917900F0917A0080E0BE\
:1004600009951F3F19F48FE021DE07C002B71EE196\
:10047000C701B60150DF8F3F11F080E008C082B79E\
:10048000801B8D33A8F302B7115091F781E01F91C3\
:100490000F91FF90EF90DF90CF900895CF92DF9271\
:1004A000EF92FF920F931F936B017C01042F122F89\
:1004B00009DF8C2D8170880F880F880FE0917900FB\
:1004C000F0917A0080640995D701C60169E0B6957C\
:1004D000A795979587956A95D1F7E0917900F09166\
:1004E0007A000995D701C601B695A7959795879586\
:1004F000E0917900F0917A000995E0917900F0910E\
:100500007A00802F09951123A9F00F3719F48FE095\
:10051000CDDD10C002B71EE1C701B601FCDE8F378A\
:1005200049F482B7801B8D33B8F302B71150A1F79D\
:1005300081E001C080E01F910F91FF90EF90DF906C\
:10054000CF90089512BA18BA8FEF81BB17BA11BABB\
:1005500093E094BB8EEF85BB93BF3CD3789441D39B\
:10056000FECFFF920F931F93CF93DF93282F792F06\
:10057000F62E80916200813011F0843039F4822FA0\
:10058000972F9C01E90110E000E0A5C0863011F032\
:100590001FEFA4C080916F0090917000622F4F2DCB\
:1005A00006D380916F0090917000A0917100B0917E\
:1005B00072008F0D911DA11DB11D80936F0090934E\
:1005C0007000A0937100B0937200809163009091CD\
:1005D00064008F1991099093640080936300892BC4\
:1005E00011F010E07BC01092620011E077C08091A2\
:1005F0006200813079F580917300909174002091B0\
:100600006F00309170004091710050917200892B01\
:1006100031F4CA01B901488121E040DF21C0CA019B\
:10062000B901488120E03ADF8091760081508093C3\
:1006300076008823A9F460916F007091700080911A\
:100640007100909172004881DDDE8091730080938B\
:10065000760006C080916F00909170006881AEDED8\
:10066000809163009091640001979093640080935F\
:100670006300892BD9F4109262008091750081FF8C\
:1006800014C08091760090E0209173003091740046\
:100690008217930751F060916F0070917000809104\
:1006A0007100909172004881ADDE11E080916F0081\
:1006B00090917000A0917100B09172000196A11DFF\
:1006C000B11D80936F0090937000A0937100B09360\
:1006D00072000F5F21960F1508F489CF812FDF91EB\
:1006E000CF911F910F91FF9008950F931F93CF9378\
:1006F000DF93282F792F062F90916200892F825047\
:10070000823020F0953051F00FEF53C0953031F02A\
:10071000822F972F9C01E90110E045C080916F0066\
:1007200090917000622F402F38D280916F0090918D\
:100730007000A0917100B0917200800F911DA11DF9\
:10074000B11D80936F0090937000A0937100B093DF\
:1007500072002FC080916200823051F460916F006E\
:10076000709170008091710090917200D4DD05C08D\
:1007700080916F009091700003DE888380916F00FC\
:1007800090917000A0917100B09172000196A11D2E\
:10079000B11D80936F0090937000A0937100B0938F\
:1007A00072001F5F21961017A8F2083010F4109203\
:1007B0006200802FDF91CF911F910F910895CF9309\
:1007C000DF93EC018981813061F49A9902C085E060\
:1007D00002C0809165007DDC10926600A998D9DC8A\
:1007E00004C0823021F4F8DCA99A20E080C1833073\
:1007F00009F5E0917900F0917A008A81099580935A\
:100800006700E0917900F0917A008B8109958093DF\
:100810006800E0917900F0917A008C8109958093CD\
:100820006900E0917900F0917A008D8109958093BB\
:100830006A005CC1843011F580916600882391F4D0\
:100840009B8180E02A8130E0822B932BAA2797FDA1\
:10085000A095BA2F80936F0090937000A0937100C1\
:10086000B09372009F8180E02E8130E0822B932B29\
:10087000909364008093630082E028C1873011F573\
:1008800080916600882391F49B8180E02A8130E08A\
:10089000822B932BAA2797FDA095BA2F80936F00E8\
:1008A00090937000A0937100B09372009F8180E0DC\
:1008B0002E8130E0822B932B909364008093630011\
:1008C00083E004C1853011F4B4DCB8C0863009F08F\
:1008D00043C080916600882391F49B8180E02A8147\
:1008E00030E0822B932BAA2797FDA095BA2F8093F7\
:1008F0006F0090937000A0937100B09372008C8190\
:1009000080937300109274008D81282F2F70209394\
:100910007500482F50E0407F507084E0440F551F11\
:100920008A95E1F78091730090917400480F591FE8\
:10093000509374004093730020FF02C040937600F0\
:100940009F8180E02E8130E0822B932B9093640076\
:100950008093630081E0BAC0883041F580916600E1\
:10096000882391F49B8180E02A8130E0822B932BB5\
:10097000AA2797FDA095BA2F80936F0090937000DF\
:10098000A0937100B09372001092740010927300E3\
:10099000109275009F8180E02E8130E0822B932B96\
:1009A000909364008093630084E090C0893081F468\
:1009B00081E0809366008A819B81AC81BD818093B8\
:1009C0006F0090937000A0937100B09372000DCFF0\
:1009D0008A3031F48A81809365001092670030C0BC\
:1009E0008B30A1F49B8180E02A8130E0822B932B15\
:1009F00090937F0080937E00C49ABC9A83E056DB7C\
:100A0000C498A99880E152DB7CD0EFCE8C3099F469\
:100A100080EC87D080E085D08AE048DBC49A85E00E\
:100A200045DBC49885E042DB87B38F7487BB88B30E\
:100A30008F7488BBD9CE8D3029F496D0809367000F\
:100A400021E055C08E3019F48A816BD0CECE8F3024\
:100A5000F1F49B8180E02A8130E0822B932BAA273E\
:100A600097FDA095BA2F80936F0090937000A0938C\
:100A70007100B09372009F8180E02E8130E0822B64\
:100A8000932B909364008093630085E01FC08031B6\
:100A900009F59B8180E02A8130E0822B932BAA27E5\
:100AA00097FDA095BA2F80936F0090937000A0934C\
:100AB0007100B09372009F8180E02E8130E0822B24\
:100AC000932B909364008093630086E08093620090\
:100AD0002FEF0DC08F3709F088CE81E0809367003B\
:100AE000109268001092690010926A0024E087E674\
:100AF00090E090938F0080938E00822FDF91CF91B2\
:100B00000895BD9ABB98C39A50E217D05A95E9F759\
:100B10000895AC0188E605D0842F03D089E601D082\
:100B2000852F0FD028E030E0382780FB869506D04F\
:100B30002A95D1F730FB02D000D06894BB98C39AB5\
:100B400016F0C398BB9AE0917E00F0917F00319738\
:100B5000F0F7C59AE6B3E3FBE0917E00F0917F00E9\
:100B60003197F0F7C598089520ECE7DF46F42A9511\
:100B7000E1F780E02AE1E5DF2A95E9F7DECF28E01A\
:100B800030E0DBDF869587F938272A95D1F7D5DF66\
:100B900027F9322772F3D1DFD0CFDB01742FB9DF11\
:100BA00084E2BFDFE1DF8D937A95D1F70895DB0111\
:100BB000742FAFDF83EFB5DF8DE1B3DF84E6B1DF04\
:100BC0008D91AFDF82E7ADDFCFDF8078D9F77A95FF\
:100BD00089F7089585B7836085BF8BB780648BBF25\
:100BE00008951F93CF93DF9360919000635067FD4A\
:100BF000A3C080918D00CCE0D0E0C81BD109CC56B9\
:100C0000DF4F80918C008D3209F084C0683009F08C\
:100C100091C083EC809380008AE5809360001092FD\
:100C200077008881807639F0CE01C9DD282F8F3F8B\
:100C300009F45FC065C09A81109289008981882378\
:100C400021F410928A0022E04DC0853019F490936F\
:100C5000910047C08630B1F58B81813019F480E571\
:100C600090E004C0823041F482E690E090938F00DF\
:100C700080938E0022E122C08330F9F48A81882398\
:100C800041F482E290E090938F0080938E0024E004\
:100C900015C0813041F486E290E090938F008093FC\
:100CA0008E002CE10BC0823041F482E490E09093FE\
:100CB0008F0080938E002EE001C020E080E48093BE\
:100CC00077001EC0883021F421E083E990E00CC059\
:100CD000893019F49093930004C08A3011F421E014\
:100CE00001C020E089E890E090938F0080938E000F\
:100CF00007C0888187FD2E8180E88093770006C039\
:100D00008F81882319F48E81821708F0822F8093B7\
:100D1000610010C08091770087FF0CC0CE0121DCFC\
:100D20008F3F21F48EE18093600004C0882311F08E\
:100D300010926100109290008091600084FF58C072\
:100D4000809161008F3F09F453C0182F893008F05B\
:100D500018E0811B809361008091800098E88927CA\
:100D600080938000112391F18091770087FF08C064\
:100D700081E890E0612FB9DC182F893098F526C002\
:100D800020918E0030918F0086FF0DC0A1E8B0E069\
:100D900080E090E0F901E80FF91FE491ED930196EE\
:100DA0001817C1F708C0912FD901E1E8F0E08D9143\
:100DB00081939150E1F71150812F90E01F5F0196D0\
:100DC000820F931F90938F0080938E0081E890E0B4\
:100DD000612F31D0612F6C5F6C3041F08FEF8093C9\
:100DE000610004C08FEF809361006EE1609360004A\
:100DF00094E180B3847131F49150D9F7109291004D\
:100E000010928B00DF91CF911F910895A82FB92FD9\
:100E100080E090E041E050EA609530E009C02D911B\
:100E200082279795879510F084279527305EC8F321\
:100E30006F5FA8F30895EADF8D939D930895CF9394\
:100E4000CFB7CF93C395849BE9F7849B09C0849B5C\
:100E500007C0849B05C0849B03C0849B01C0A1C0C4\
:100E6000DF93C0918D00DD27CC56DF4F849B02C0FD\
:100E7000DF91EBCF2F930F931F9300B32FEF04FB62\
:100E800020F94F933F9310B34FEF012704FB21F953\
:100E90003BE031C04E7F012F10B3216028C0102FDE\
:100EA0004D7F2260000000B329C04B7F2460012FDA\
:100EB000000010B32BC010B3477F28602AC04F7EBC\
:100EC00000B320612CC04F7D10B320622FC04F7B38\
:100ED00000B3206432C0422700B349934FEF0000B3\
:100EE000102714FB20F910B31471C9F1297F91F276\
:100EF000012704FB21F900B3237F89F2315058F117\
:100F0000102714FB22F910B3277E79F2012704FB86\
:100F100023F92F7C81F200B3102714FB24F92F79D9\
:100F200071F200C010B3012704FB25F92F7359F2A9\
:100F300000C000B3102714FB26F9223040F200C095\
:100F400010B3012704FB27F9243028F64F772068D7\
:100F500010B30000F9CF10E41ABF002717C03B50B0\
:100F60003195C31BD04010E41ABF0881033CE9F05F\
:100F70000B34D9F020918B001981110F1213EDCF92\
:100F8000093641F10D3211F0013E39F7009392001C\
:100F90003F914F911F910F912F91DF91CAB7C6FDDD\
:100FA00051CFCF91CFBFCF9118952091920022239E\
:100FB00079F310919000112311F5343012F1309330\
:100FC000900020938C0010918D003BE0311B3093FA\
:100FD0008D0017C00091900001308CF40AE530912B\
:100FE000600034FD10C000936000C0E8D0E00FC086\
:100FF0002795A8F45150A9F4220F0000F9CF4AE533\
:1010000003C042ED01C0432FC4E1D0E032E011B390\
:101010001461949A11BB02B320E414E15F93012799\
:1010200056E002BB279520F4515021F4220FF9CF4E\
:10103000012756E000003B5A02BBD0F2279528F466\
:10104000515029F4220F0000F9CF012756E02795CF\
:1010500002BB20F4515021F4220FF9CF012756E0B2\
:101060002991332302BB21F60B7E10919100110FC1\
:10107000C651D04002BB11F010938B0010E41ABF90\
:10108000006111B31B7E402F4B7E5F9100C000C0FA\
:0C10900002BB11BB42BB7CCFF894FFCF29\
:02109C005AFFF9\
:00000001FF\
"
#endif
    
#if BOOT_ATMEGA16A
"\
:103800000C94681C0C94A01C0C94851C0C94851CB6\
:103810000C94851C0C94851C0C94851C0C94851CA4\
:103820000C94851C0C94851C0C94851C0C94851C94\
:103830000C94851C0C94851C0C94851C0C94851C84\
:103840000C94851C0C94851C0C94851C0C94851C74\
:103850000C94851C0403090412036F0062006400C9\
:10386000650076002E0061007400100348004900D6\
:10387000440042006F006F0074001201100100004C\
:103880000008C016DF050001010200010902220044\
:103890000101008032090400000103000000092139\
:1038A00001010001222100070581030800C806006C\
:1038B000FF0901A101150026FF0075088501950685\
:1038C0000900B20201850295830900B20201C0001D\
:1038D00011241FBECFE5D4E0DEBFCDBF10E0A0E6CF\
:1038E000B0E0E6E4FFE302C005900D92AA36B1070E\
:1038F000D9F710E0AAE6B0E001C01D92AB39B107DC\
:10390000E1F70E94D11D0C94A11F0C94001CA82F5C\
:10391000B92F80E090E041E050EA60956F5F58F485\
:103920002D9138EF82279795879510F0842795275A\
:103930003F5FC8F3F3CF0895EADF8D939D93089519\
:10394000CF93CFB7CF93C395849BE9F7849B09C0EE\
:10395000849B07C0849B05C0849B03C0849B01C0DB\
:10396000A3C0DF93C0917E00DD27CB57DF4F849B40\
:1039700002C0DF91EBCF2F930F931F9300B32FEF74\
:1039800004FB20F94F933F9310B34FEF012704FB43\
:1039900021F93BE031C04E7F012F10B3216028C0D8\
:1039A000102F4D7F2260000000B329C04B7F2460A0\
:1039B000012F000010B32BC010B3477F28602AC02E\
:1039C0004F7E00B320612CC04F7D10B320622FC00A\
:1039D0004F7B00B3206432C0422700B349934FEFBE\
:1039E0000000102714FB20F910B31471C9F1297FCE\
:1039F00091F2012704FB21F900B3237F89F23150B2\
:103A000058F1102714FB22F910B3277E79F2012711\
:103A100004FB23F92F7C81F200B3102714FB24F957\
:103A20002F7971F200C010B3012704FB25F92F7321\
:103A300059F200C000B3102714FB26F9223040F2DF\
:103A400000C010B3012704FB27F9243028F64F7774\
:103A5000206810B30000F9CF10E41ABF002719C086\
:103A60003B503195C31BD04010E41ABF0881033C82\
:103A7000F9F00B34E9F020917C001981110F121339\
:103A8000EDCF4A81441F093641F10D3211F0013E5C\
:103A900029F7009383003F914F911F910F912F9130\
:103AA000DF91CAB7C6FD4FCFCF91CFBFCF91189549\
:103AB00020918300222379F310918100112321F5B5\
:103AC000343022F13093810020937D0010917E00EC\
:103AD0003BE0311B30937E0019C000918100013022\
:103AE0009CF40AE54F7081F43091600034FD10C001\
:103AF00000936000C1E7D0E00FC02795A8F45150B3\
:103B0000A9F4220F0000F9CF4AE503C042ED01C03D\
:103B1000432FC4E1D0E032E011B31461949A11BB99\
:103B200002B320E414E15F93012756E002BB27951E\
:103B300020F4515021F4220FF9CF012756E0000064\
:103B40003B5A02BBD0F2279528F4515029F4220F9A\
:103B50000000F9CF012756E0279502BB20F4515011\
:103B600021F4220FF9CF012756E02991332302BB1C\
:103B700021F60B7E10918200110FC651D04002BB7E\
:103B800011F010937C0010E41ABF006111B31B7E8A\
:103B9000402F4B7E5F9100C000C002BB11BB42BBF7\
:103BA0007ACF91E097BB85E088BB88E28A95F1F7F0\
:103BB000B299AEC19BBF82E08BBF85B7836085BFE2\
:103BC0008BB780648BBF8C9A20E048EB5BE0A895B4\
:103BD000CA010197F1F72150D1F78C987894C0E091\
:103BE000D0E0FF2400E0EE24E3945EE9C52E58E324\
:103BF000D52E4AE6442E48E3542E38E5232E38E3EA\
:103C0000332E2EEEA22E2FEFB22EAC0CBD1C9AE757\
:103C1000892E98E3992E82E6682E80E0782EA8956A\
:103C200090918100292F235027FD0DC180917E00A6\
:103C3000ACE0B0E0A81BB109AB57BF4F80917D004D\
:103C40008D3209F0B0C0283009F0FBC083EC8093BE\
:103C500071009AE59093600010926A002C91822F77\
:103C6000807611969C9111978823D1F0993079F440\
:103C700012968C911297823031F410926D0027FDCC\
:103C800084C09FEF84C0E1E0E0936E0052C19130A8\
:103C900009F04FC17092800060927F0027E04AC116\
:103CA00012968C91129710927A00992331F4109207\
:103CB0007B008AE790E022E063C0953019F480939E\
:103CC00082005BC0963009F048C013968C91139720\
:103CD000813029F49092800080927F001DC0823054\
:103CE00031F4B0928000A0927F0022E232C0833093\
:103CF000E9F412968C911297882341F484E598E3B5\
:103D00009093800080937F0024E023C0813031F4C1\
:103D10003092800020927F0022E11BC08230C1F4EB\
:103D20005092800040927F0020E113C0813231F434\
:103D3000D0928000C0927F0029E00BC0823241F413\
:103D4000EEEAF8E3F0938000E0937F0021E201C007\
:103D500020E0F0E4F0936A00EDC0983019F484E8B4\
:103D600090E009C0993019F48093840006C09A301D\
:103D700021F48AE790E021E003C08AE790E020E0A8\
:103D80009093800080937F00D5C016969C9180E828\
:103D900080936A0005C016969C91921708F0922FA6\
:103DA000909361004EC080916A0087FF4AC0C0981E\
:103DB00060916B0070916C0080916D00882349F4D4\
:103DC00011966C91119712967C9112971496292F47\
:103DD0002750322F380F30936D00862F8F7751F494\
:103DE000F89483E0FB0180935700E895789407B638\
:103DF00000FCFDCFF894AB018D919C911197FB01D4\
:103E00000C01E0925700E895112478946E5F7F4F83\
:103E1000862F8F7751F4F89485E0FA01809357004C\
:103E2000E895789407B600FCFDCF225011F0129669\
:103E3000D4CF70936C0060936B0037FF02C0109278\
:103E40006100109281008091600084FF4AC08091DF\
:103E500061008F3F09F445C0182F893008F018E041\
:103E6000811B809361008091710098E8892780937D\
:103E70007100112341F120917F00309180008091E9\
:103E80006A0086FF0DC0A2E7B0E080E090E0F90193\
:103E9000E80FF91FE491ED9301961817C1F708C0D8\
:103EA000D901912FE2E7F0E08D9181939150E1F7F4\
:103EB0001150812F90E01F5F0196820F931F909306\
:103EC000800080937F0082E790E0612F0E949C1C1D\
:103ED000612F6C5F6C3019F08FEF809361006093FD\
:103EE000600094E180B3847131F49150D9F710925D\
:103EF000820010927C0080916E00882321F0FA9459\
:103F000011F4015029F02196D6FDC09AB29B87CEBC\
:103F1000F89481E180935700E8951BBE15BE81E0BF\
:103F20008BBF1BBE17BA18BAE0916F00F0917000FA\
:103F3000099520E017968C911797882309F42BCFC9\
:063F40002ECFF894FFCF24\
:0A3F46005AFF018000004000000057\
:0400000300003800C1\
:00000001FF\
\
"
#endif

#if BOOT_ATMEGA8A
"\
:1018000050C084C069C068C067C066C065C064C09D\
:1018100063C062C061C060C05FC05EC05DC05CC0CC\
:101820005BC05AC059C00403090412036F00620070\
:101830006400650076002E0061007400100348000B\
:101840004900440042006F006F0074001201100153\
:1018500000000008C016DF050001010200010902B6\
:101860002200010100803209040000010300000091\
:10187000092101010001222100070581030800C898\
:101880000600FF0901A101150026FF00750885016A\
:1018900095060900B20201850295830900B2020192\
:1018A000C00011241FBECFE5D4E0DEBFCDBF10E0E5\
:1018B000A0E6B0E0E2E1FFE102C005900D92AA3699\
:1018C000B107D9F710E0AAE6B0E001C01D92AB392C\
:1018D000B107E1F74CD11BC393CFA82FB92F80E0FC\
:1018E00090E041E050EA60956F5F58F42D9138EF39\
:1018F00082279795879510F0842795273F5FC8F337\
:10190000F3CF0895EADF8D939D930895CF93CFB7DA\
:10191000CF93C395849BE9F7849B09C0849B07C040\
:10192000849B05C0849B03C0849B01C0A3C0DF933C\
:10193000C0917E00DD27CB57DF4F849B02C0DF9133\
:10194000EBCF2F930F931F9300B32FEF04FB20F9DE\
:101950004F933F9310B34FEF012704FB21F93BE076\
:1019600031C04E7F012F10B3216028C0102F4D7F52\
:101970002260000000B329C04B7F2460012F0000CB\
:1019800010B32BC010B3477F28602AC04F7E00B32E\
:1019900020612CC04F7D10B320622FC04F7B00B35D\
:1019A000206432C0422700B349934FEF0000102754\
:1019B00014FB20F910B31471C9F1297F91F20127AA\
:1019C00004FB21F900B3237F89F2315058F110272D\
:1019D00014FB22F910B3277E79F2012704FB23F9C7\
:1019E0002F7C81F200B3102714FB24F92F7971F2B8\
:1019F00000C010B3012704FB25F92F7359F200C072\
:101A000000B3102714FB26F9223040F200C010B3B7\
:101A1000012704FB27F9243028F64F77206810B3FC\
:101A20000000F9CF10E41ABF002719C03B503195D0\
:101A3000C31BD04010E41ABF0881033CF9F00B34FB\
:101A4000E9F020917C001981110F1213EDCF4A812A\
:101A5000441F093641F10D3211F0013E29F7009380\
:101A600083003F914F911F910F912F91DF91CAB742\
:101A7000C6FD4FCFCF91CFBFCF9118952091830056\
:101A8000222379F310918100112321F5343022F1C2\
:101A90003093810020937D0010917E003BE0311B4C\
:101AA00030937E0019C00091810001309CF40AE55A\
:101AB0004F7081F43091600034FD10C000936000DD\
:101AC000C1E7D0E00FC02795A8F45150A9F4220F28\
:101AD0000000F9CF4AE503C042ED01C0432FC4E145\
:101AE000D0E032E011B31461949A11BB02B320E448\
:101AF00014E15F93012756E002BB279520F4515073\
:101B000021F4220FF9CF012756E000003B5A02BB17\
:101B1000D0F2279528F4515029F4220F0000F9CF74\
:101B2000012756E0279502BB20F4515021F4220FE3\
:101B3000F9CF012756E02991332302BB21F60B7E12\
:101B400010918200110FC651D04002BB11F01093CA\
:101B50007C0010E41ABF006111B31B7E402F4B7E46\
:101B60005F9100C000C002BB11BB42BB7ACF88E0CE\
:101B700084BB8CE085BB88E28A95F1F79A99AEC167\
:101B800081E08BBF82E08BBF85B7836085BF8BB759\
:101B900080648BBF8C9A20E048EB5BE0A895CA017B\
:101BA0000197F1F72150D1F78C987894C0E0D0E0FC\
:101BB000FF2400E0EE24E39450E7C52E58E1D52E33\
:101BC0004CE3442E48E1542E3AE2232E38E1332EE2\
:101BD0002EEEA22E2FEFB22EAC0CBD1C9CE4892E53\
:101BE00098E1992E82E6682E80E0782EA895909153\
:101BF0008100292F235027FD0DC180917E00ACE08C\
:101C0000B0E0A81BB109AB57BF4F80917D008D326A\
:101C100009F0B0C0283009F0FBC083EC809371005C\
:101C20009AE59093600010926A002C91822F807642\
:101C300011969C9111978823D1F0993079F41296DE\
:101C40008C911297823031F410926D0027FD84C080\
:101C50009FEF84C0E1E0E0936E0051C1913009F044\
:101C60004EC17092800060927F0027E049C11296B9\
:101C70008C91129710927A00992331F410927B0084\
:101C80008AE790E022E063C0953019F480938200E7\
:101C90005BC0963009F048C013968C911397813041\
:101CA00029F49092800080927F001DC0823031F430\
:101CB000B0928000A0927F0022E232C08330E9F42B\
:101CC00012968C911297882341F486E298E19093C2\
:101CD000800080937F0024E023C0813031F4309273\
:101CE000800020927F0022E11BC08230C1F450921C\
:101CF000800040927F0020E113C0813231F4D09205\
:101D00008000C0927F0029E00BC0823241F4E0E8FD\
:101D1000F8E1F0938000E0937F0021E201C020E031\
:101D2000F0E4F0936A00ECC0983019F484E890E095\
:101D300009C0993019F48093840006C09A3021F4C8\
:101D40008AE790E021E003C08AE790E020E09093EA\
:101D5000800080937F00D4C016969C9180E8809389\
:101D60006A0005C016969C91921708F0922F9093E6\
:101D700061004EC080916A0087FF4AC0AB986091B5\
:101D80006B0070916C0080916D00882349F411966E\
:101D90006C91119712967C9112971496292F2750C7\
:101DA000322F380F30936D00862F8F7351F4F894D3\
:101DB00083E0FB0180935700E895789407B600FC18\
:101DC000FDCFF894AB018D919C911197FB010C0113\
:101DD000E0925700E895112478946E5F7F4F862F2C\
:101DE0008F7351F4F89485E0FA0180935700E895D9\
:101DF000789407B600FCFDCF225011F01296D4CF94\
:101E000070936C0060936B0037FF02C0109261000A\
:101E1000109281008091600084FF49C08091610030\
:101E20008F3F09F444C0182F893008F018E0811B57\
:101E3000809361008091710098E8892780937100F8\
:101E4000112341F120917F003091800080916A0040\
:101E500086FF0DC0A2E7B0E080E090E0F901E80F56\
:101E6000F91FE491ED9301961817C1F708C0D90145\
:101E7000912FE2E7F0E08D9181939150E1F71150BD\
:101E8000812F90E01F5F0196820F931F9093800037\
:101E900080937F0082E790E0612F34DD612F6C5FDB\
:101EA0006C3019F08FEF809361006093600094E1D3\
:101EB00080B3847131F49150D9F71092820010925E\
:101EC0007C0080916E00882321F0FA9411F4015077\
:101ED00029F02196D6FDAB9A9A9B88CEF89481E1A1\
:101EE00080935700E8951BBE15BE81E08BBF1BBEDB\
:101EF00017BA18BAE0916F00F0917000099520E0D0\
:101F000017968C911797882309F42CCF2FCFF8942C\
:021F1000FFCF01\
:0A1F12005AFF01400000200000000B\
:00000001FF\
\
" //был удален выше кусок!!! - :0400000300001800E1
/*
"\
:100000000C942A000C9434000C9434000C943400AA\
:100010000C9434000C9434000C9434000C94340090\
:100020000C9434000C9434000C9434000C94340080\
:100030000C9434000C9434000C9434000C94340070\
:100040000C9434000C9434000C9434000C94340060\
:100050000C94340011241FBECFE5D4E0DEBFCDBF29\
:100060000E943C000C944C000C940000B89AC09A7A\
:100070000895B89AC0980895B89A41E02CE231E00A\
:1000800088B3842788BB8CE291E0F9013197F1F7BE\
:0C0090000197D9F7A895F4CFF894FFCFA2\
:00000001FF\
"*/
#endif
};



uint16_t parserHEX_buf [PROG_AVR_FLASH_PAGE_MAX_SIZE];



// https://ru.wikipedia.org/wiki/Intel_HEX
#include "hal.h"

uint8_t *progAVR_cntbt;
msg_t progAVR_get_c (uint8_t *byte)
{
    msg_t resp = FUNCTION_RETURN_ERROR;
    if (NULL != progAVR_cntbt)
    {
        if ('\0' != progAVR_cntbt)
        {
            *byte = *progAVR_cntbt;
            progAVR_cntbt++;
            resp = FUNCTION_RETURN_OK;
        }
    }
    return resp;
}


msg_t progAVR_get_byte (uint8_t *byte)
{
    msg_t resp = FUNCTION_RETURN_ERROR;
    uint8_t tmpH, tmpL;
    
    if (FUNCTION_RETURN_OK == progAVR_get_c (&tmpH))
    {
        if (FUNCTION_RETURN_OK == progAVR_get_c (&tmpL))
        {
            *byte = (char2hex(tmpH) << 4) | char2hex(tmpL);
            resp = FUNCTION_RETURN_OK;
        }
    }
    return resp;
}



    
msg_t progAVR_go (void)
{
    msg_t resp = FUNCTION_RETURN_ERROR;
    uint32_t i, j, size;
    uint8_t tmp8, tmp_c;
    uint16_t tmp16;
    uint16_t cnt_out = 0;
    
    uint8_t  length;
    uint16_t address; //32!
    uint8_t  type;
    uint8_t  checksum;
    uint16_t adr_write = 0;
    
    progAVR_cntbt = (uint8_t *)&pHEX[0];
    
    _debug_out((char *)"Start AVR programming...\n");
    if (FUNCTION_RETURN_ERROR != progAVR_init())
    {

        for (i = 0; i < 4; i++)
        {
            progAVR_xspi(0x38);
            progAVR_xspi(0x00);
            progAVR_xspi((uint8_t)i & 0x03);
            progAVR_calibByte[i] = progAVR_xspi(0xFF); // read calib byte
            //1 - 0xBD
            //2 - 0xBD
            //3 - 0xB9
            //4 - 0xBA
            
            //0x3E
            //0x38
            //0xFF
            //0xFF
        }
        xsprintf(_str, "CLB:%02X:%02X:%02X:%02X", progAVR_calibByte[0], progAVR_calibByte[1], progAVR_calibByte[2], progAVR_calibByte[3]);
        paint_putStrColRow (0, 7, _str);
    
        //return 0;
        progAVR_erase_all();
    
        //clear all
        if (ATMEGA16A == progAVR_mcu)
        {
            adr_write = 112; // for boot
        }
        else if (ATMEGA8A == progAVR_mcu)
        {
            adr_write = 96;//192;
        }
        else
        {
            adr_write = 0;
        }
        checksum = 0;
        cnt_out = 0;
        
//         for (i = 0; i < 64*2; i++)
//         {
//             uint8_t *pn = (uint8_t *)progAVR_FLASH_buf;
//             pn[i] = i;
//         }
//         progAVR_FLASH_page_write (0, &progAVR_FLASH_buf[0]);

        for (i = 0; i < progAVR_constFLASHpageSize[progAVR_mcu]; i++) // чистим буфер FLASH
        {
            progAVR_FLASH_buf[i] = 0xFFFF;
        }
        
        while (1) //декодируем 
        {
            if (FUNCTION_RETURN_ERROR == progAVR_get_c(&tmp8))
                break;
            if (':' == tmp8)
            {
                checksum = 0;
                
                // loading parameters
                if (FUNCTION_RETURN_ERROR == progAVR_get_byte(&tmp8))
                    break;
                length = tmp8 / 2; // in words (16 bits)
                //checksum += tmp8;
                
                if (FUNCTION_RETURN_ERROR == progAVR_get_byte(&tmp8))
                    break;
                checksum += tmp8;
                address = (uint16_t )tmp8 << 8;
                if (FUNCTION_RETURN_ERROR == progAVR_get_byte(&tmp8))
                    break;
                checksum += tmp8;
                address |= tmp8;

                if (FUNCTION_RETURN_ERROR == progAVR_get_byte(&tmp8))
                    break;
                checksum += tmp8;
                type = tmp8;

                if (0x00 != type) //EOF
                {
                    break;
                }
                else
                {
                    // reading data !!!!!!!!!!!!!!! bytes not operated for normel orient!!!!!!!!!
                    //checksum = 0;
                    for (i = 0; i < length; i++) // 8 iterations max
                    {
                        tmp16 = 0;
                        if (FUNCTION_RETURN_ERROR == progAVR_get_byte(&tmp8))
                            break;
                        checksum += tmp8;
                        tmp16 |= (uint16_t)tmp8 ;
                        if (FUNCTION_RETURN_ERROR == progAVR_get_byte(&tmp8))
                            break;
                        checksum += tmp8;
                        tmp16 |= (uint16_t)tmp8 << 8;
                        progAVR_FLASH_buf [cnt_out + i] = tmp16;
                        
                    }
                    cnt_out += length;
                }
                // check crc
                if (FUNCTION_RETURN_ERROR == progAVR_get_byte(&tmp8))
                    break;

                tmp8 = 0 - tmp8;
                //if (checksum != (0 - tmp8))
                //    break;
                
                if (cnt_out >= progAVR_constFLASHpageSize[progAVR_mcu])
                {
                    cnt_out = 0;
                    progAVR_FLASH_page_write (adr_write, &progAVR_FLASH_buf[0]);
                    for (i = 0; i < progAVR_constFLASHpageSize[progAVR_mcu]; i++)
                    {
                        progAVR_FLASH_buf[i] = 0xFFFF;
                    }
                    adr_write++;
                }
            }

        }
        // writing остаток!
        progAVR_FLASH_page_write (adr_write, &progAVR_FLASH_buf[0]);
        
        //check
        i = 0;
        for (; i < 12; i++)
        {
            progAVR_FLASH_byte_read (i * 8, &tmp16);
            progAVR_FLASH_buf[i] = tmp16;
            //dprintf(("%04x", tmp16));
            xsprintf(_str, "%04x", tmp16);
            _debug_out(_str);
            paint_putStrColRow (0, 8 + i, _str);
        }
        if (ATMEGA16A == progAVR_mcu)
        {
            progAVR_fuzeL = 0xEF;
            progAVR_fuzeH = 0xD0; // jtag-off, boot-on
            progAVR_lock  = 0xEF;
        }
        else if (ATTINY13 == progAVR_mcu)
        {
            progAVR_fuzeL = 0x7A; // div8-off
            progAVR_fuzeH = 0xFF; //
            progAVR_lock  = 0xFF; 
        }
        else if (ATMEGA8A == progAVR_mcu)
        {
            progAVR_fuzeL = 0xEF;
            progAVR_fuzeH = 0xD8; //
            progAVR_lock  = 0xFF; 
        }
        else if (ATMEGA8515 == progAVR_mcu)
        {
            progAVR_fuzeL = 0xEF; //0xE1;
            progAVR_fuzeH = 0xC9; //
            progAVR_lock  = 0xFF; 
        }
        else
        {
            while(1){};
        }
        //while(1){};
        progAVR_FUSE_write ();
        progAVR_FUSE_read();
        xsprintf(_str, "L%02X H%02X K%02X E%02X", 
            progAVR_fuzeL,
            progAVR_fuzeH,
            progAVR_lock,
            progAVR_exten);
        paint_putStrColRow (0, 3, _str);

        resp = FUNCTION_RETURN_OK;
    }
    progAVR_off_lines ();
    return resp;
}
